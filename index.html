<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文手年度总结小票生成</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 替换为 html-to-image，渲染更精准 -->
    <script src="https://unpkg.com/html-to-image@1.11.11/dist/html-to-image.js"></script>
    
    <style>
        body {
            background-color: #121212;
            color: #d4d4d8;
            font-family: 'Courier New', Courier, monospace;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }

        /* --- 样式重置 --- */
        /* 使用 html-to-image 后，不需要任何奇怪的 CSS hack，直接写正常样式即可 */
        
        .receipt-container {
            font-family: 'Courier New', Courier, monospace !important;
            line-height: 1.5; /* 恢复正常的行高 */
        }

        .receipt-label {
            background-color: black;
            color: white;
            display: inline-block;
            padding: 2px 6px;
            font-weight: 800;
            font-size: 12px;
            vertical-align: middle; 
        }

        .receipt-big-number {
            font-size: 3rem; 
            font-weight: 900;
            display: block;
            margin: 10px 0;
            letter-spacing: -2px;
            line-height: 1; 
        }

        .receipt-text {
            text-align: justify;
            line-height: 1.6;
            font-size: 12px;
            font-weight: 700;
        }
        
        .dashed-line {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            letter-spacing: 2px;
            font-weight: bold;
            margin: 16px 0;
            color: #000;
        }

        .receipt-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        // 图标组件
        const Printer = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const RefreshCw = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>;
        const Wand2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"></path><path d="m14 7 3 3"></path><path d="M5 6v4"></path><path d="M19 14v4"></path><path d="M10 2v2"></path><path d="M7 8H3"></path><path d="M21 16h-4"></path></svg>;
        const ChevronDown = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"></path></svg>;
        const ChevronUp = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"></path></svg>;

        const STOP_WORDS = new Set([
            '的', '了', '是', '在', '我', '有', '和', '就', '不', '人', '都', '一个', '上', '也', '很', '到', '说', '要', '去', '你', '会', '着', '没有', '看', '好', '自己', '这', '那', '我们', '你们', '他们', '它', '只是', '但是', '因为', '所以', '如果', '为了', '能够', '这个', '那个', '其实', '已经', '还是', '以及', '或者', '可以'
        ]);

        function WriterReceiptApp() {
            const [formData, setFormData] = useState({
                userName: '查理白花猫',
                year: '2025',
                totalWords: '125,800',
                top1: '《我的同事得了暴食症》',
                top2: '《洞穴里的孩子》',
                top3: '《百分百坦诚》',
                keywords: '坦诚, 爱, 女人, 偶像, 真相, 真实, 眼泪, 恐惧',
                bestOpening: '梦，生命诞生时就被神漏掉的场所。',
                bestEnding: '和姐姐三十年前出生的时候一样，觉得很幸福。',
                bestParagraph: '这样的身体，更接近偶像一些了吗？只能抓起大腿上的一层皮，舞台光打下来的时候好像能看见血管，皮肤透明得像膜。',
                freeTalk: '今年感谢遇到了大家，每一字都是真心。大家新年快乐！',
            });

            const [analysisText, setAnalysisText] = useState('');
            const [suggestedKeywords, setSuggestedKeywords] = useState([]);
            const [isAnalysisOpen, setIsAnalysisOpen] = useState(false);
            const [isGenerating, setIsGenerating] = useState(false);
            const receiptRef = useRef(null);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                let newValue = value;
                if (name === 'totalWords') {
                    const rawValue = value.replace(/,/g, '').replace(/\D/g, '');
                    if (rawValue) {
                        newValue = Number(rawValue).toLocaleString();
                    } else {
                        newValue = '';
                    }
                }
                setFormData(prev => ({ ...prev, [name]: newValue }));
            };

            const analyzeText = () => {
                if (!analysisText.trim()) return;
                const cleanText = analysisText.replace(/[^\u4e00-\u9fa5a-zA-Z]/g, ' ');
                let segments = [];
                try {
                    const segmenter = new Intl.Segmenter('zh-CN', { granularity: 'word' });
                    segments = Array.from(segmenter.segment(cleanText)).map(s => s.segment);
                } catch (e) {
                    segments = cleanText.split(/\s+/);
                }
                const wordCounts = {};
                for (const word of segments) {
                    if (word.length > 1 && !STOP_WORDS.has(word)) {
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    }
                }
                const sortedWords = Object.entries(wordCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 12)
                    .map(entry => entry[0]);
                setSuggestedKeywords(sortedWords);
            };

            const addKeyword = (word) => {
                setFormData(prev => {
                    const current = prev.keywords ? prev.keywords.split(/[,，]/).map(s => s.trim()).filter(Boolean) : [];
                    if (!current.includes(word)) {
                        return { ...prev, keywords: [...current, word].join(', ') };
                    }
                    return prev;
                });
            };

            // --- 使用 html-to-image 进行快照生成 ---
            const downloadReceipt = async () => {
                if (!receiptRef.current) return;
                setIsGenerating(true);

                try {
                    // 1. 创建隐藏的容器，放置在屏幕视口之外，防止闪烁
                    // 必须确保它在 DOM 中，但不可见
                    const snapshotContainer = document.createElement('div');
                    snapshotContainer.style.position = 'fixed';
                    snapshotContainer.style.top = '-10000px'; // 移出视口
                    snapshotContainer.style.left = '-10000px';
                    snapshotContainer.style.width = '380px'; // 锁定宽度
                    snapshotContainer.style.zIndex = '-1';
                    document.body.appendChild(snapshotContainer);

                    // 2. 克隆节点
                    const clone = receiptRef.current.cloneNode(true);

                    // 3. 样式重置：确保图片版是干净的白底，无阴影
                    clone.style.transform = 'none';
                    clone.style.margin = '0';
                    clone.style.boxShadow = 'none'; // 移除阴影
                    clone.style.borderRadius = '0';
                    clone.style.width = '100%';
                    clone.style.height = 'auto';
                    clone.style.backgroundColor = '#ffffff'; // 强制白底

                    snapshotContainer.appendChild(clone);

                    // 4. 使用 html-to-image 生成图片
                    // pixelRatio: 3 保证高清
                    const dataUrl = await htmlToImage.toPng(clone, {
                        quality: 1.0,
                        pixelRatio: 3, 
                        backgroundColor: '#ffffff'
                    });

                    // 5. 下载
                    const link = document.createElement('a');
                    link.download = `2025年度总结小票_${formData.userName}.png`;
                    link.href = dataUrl;
                    link.click();

                    // 6. 清理
                    document.body.removeChild(snapshotContainer);

                } catch (error) {
                    console.error('生成失败:', error);
                    alert('生成失败，请重试');
                } finally {
                    setIsGenerating(false);
                }
            };

            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const getCloudStyle = (index) => {
                const styles = [
                    'text-2xl font-black', 'text-lg font-bold', 'text-sm font-medium opacity-80',
                    'text-xl font-bold', 'text-base font-medium', 'text-xs font-light opacity-70',
                ];
                return styles[index % styles.length];
            };
            
            const DashedLine = () => (
                <div className="dashed-line">
                    --------------------------------------------------------------------------------
                </div>
            );

            return (
                <div className="min-h-screen p-4 md:p-8 selection:bg-zinc-700 selection:text-white">
                    <div className="max-w-7xl mx-auto flex flex-col md:flex-row gap-10 items-start">
                        
                        {/* 左侧控制台 */}
                        <div className="w-full md:w-1/2 bg-[#1a1a1a] border border-zinc-800 rounded-sm shadow-2xl p-6 relative overflow-hidden flex flex-col">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-zinc-800 via-zinc-600 to-zinc-800"></div>
                            <div className="border-b border-zinc-800 pb-4 mb-6">
                                <h1 className="text-xl md:text-2xl font-bold text-white tracking-wider flex items-center gap-2">
                                    <Printer className="text-zinc-500" />
                                    <span>文手年度总结小票生成</span>
                                </h1>
                                <p className="text-zinc-500 text-xs mt-1 uppercase tracking-widest">Writer Annual Summary Generator v1.0</p>
                            </div>

                            <div className="space-y-6 flex-grow">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="group">
                                        <label className="block text-xs font-bold text-zinc-400 mb-1 tracking-wider group-focus-within:text-white transition-colors">作者昵称</label>
                                        <input type="text" name="userName" value={formData.userName} onChange={handleInputChange} className="w-full bg-[#0a0a0a] border border-zinc-700 p-2 text-sm text-white focus:border-white focus:outline-none transition-colors rounded-sm" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-zinc-400 mb-1 tracking-wider group-focus-within:text-white transition-colors">年度总字数</label>
                                        <input type="text" name="totalWords" value={formData.totalWords} onChange={handleInputChange} className="w-full bg-[#0a0a0a] border border-zinc-700 p-2 text-sm text-white focus:border-white focus:outline-none transition-colors rounded-sm font-mono" />
                                    </div>
                                </div>

                                <div className="p-4 bg-[#141414] border border-zinc-800 rounded-sm relative">
                                    <span className="absolute -top-2 left-3 bg-[#1a1a1a] px-2 text-xs font-bold text-zinc-500">TOP 3 作品数据库</span>
                                    <div className="space-y-3 mt-1">
                                        {['top1', 'top2', 'top3'].map((field, idx) => (
                                            <div key={field} className="flex items-center gap-2">
                                                <span className="text-xs text-zinc-500 font-mono w-8">NO.0{idx + 1}</span>
                                                <input type="text" name={field} value={formData[field]} onChange={handleInputChange} placeholder={`第 ${idx + 1} 名作品`} className="w-full bg-[#0a0a0a] border border-zinc-700 p-2 text-sm text-white focus:border-white focus:outline-none rounded-sm placeholder-zinc-700" />
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-xs font-bold text-zinc-400 tracking-wider">年度关键词提取</label>
                                        <button onClick={() => setIsAnalysisOpen(!isAnalysisOpen)} className="text-xs text-black bg-white hover:bg-zinc-200 font-bold px-3 py-1 rounded-sm transition-all flex items-center gap-1">
                                            {isAnalysisOpen ? <ChevronUp /> : <ChevronDown />}
                                            {isAnalysisOpen ? '关闭分析器' : '打开文本分析器'}
                                        </button>
                                    </div>
                                    {isAnalysisOpen && (
                                        <div className="mb-3 p-3 bg-[#141414] border border-zinc-800 animate-in fade-in slide-in-from-top-2 duration-300">
                                            <textarea className="w-full h-24 p-2 text-xs bg-[#0a0a0a] border border-zinc-700 text-zinc-300 mb-2 focus:outline-none focus:border-zinc-500 resize-none" placeholder="在此处粘贴你的文章片段..." value={analysisText} onChange={(e) => setAnalysisText(e.target.value)}></textarea>
                                            <div className="flex justify-between items-center">
                                                <button onClick={analyzeText} className="bg-white text-black px-4 py-1.5 text-xs font-bold flex items-center gap-1 hover:bg-zinc-200 rounded-sm transition-colors shadow-sm"><Wand2 /> 开始提取关键词</button>
                                                <span className="text-[10px] text-zinc-600">本地处理，不上传数据</span>
                                            </div>
                                            {suggestedKeywords.length > 0 && (
                                                <div className="mt-2 flex flex-wrap gap-2 pt-2 border-t border-zinc-800">
                                                    {suggestedKeywords.map((word, i) => (
                                                        <button key={i} onClick={() => addKeyword(word)} className="bg-zinc-800 text-zinc-300 border border-zinc-700 px-2 py-0.5 text-[10px] hover:bg-white hover:text-black transition-colors">+ {word}</button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                    <input type="text" name="keywords" value={formData.keywords} onChange={handleInputChange} className="w-full bg-[#0a0a0a] border border-zinc-700 p-2 text-sm text-white focus:border-white focus:outline-none rounded-sm" />
                                </div>

                                <div className="space-y-4">
                                    {[
                                        { key: 'bestOpening', label: '最满意的开头' },
                                        { key: 'bestEnding', label: '最满意的结尾' },
                                        { key: 'bestParagraph', label: '高光片段 / 金句' },
                                        { key: 'freeTalk', label: 'Free Talk / 碎碎念' }
                                    ].map(({ key, label }) => (
                                        <div key={key}>
                                            <label className="block text-xs font-bold text-zinc-400 mb-1 tracking-wider group-focus-within:text-white transition-colors">{label}</label>
                                            <textarea name={key} rows={key === 'bestParagraph' ? 4 : 3} value={formData[key]} onChange={handleInputChange} className="w-full bg-[#0a0a0a] border border-zinc-700 p-2 text-sm text-white focus:border-white focus:outline-none rounded-sm resize-none placeholder-zinc-800" placeholder="在此输入..." />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 右侧：小票预览区域 */}
                        <div className="w-full md:w-1/2 flex flex-col items-center sticky top-8">
                            <div className="relative overflow-hidden w-[420px] pb-10 flex justify-center -mt-1 z-10 pt-1">
                                {/* 小票本体 - 移除 shadow 避免外层 margin 干扰，这里只在 UI 展示时有 shadow */}
                                <div ref={receiptRef} className="w-[380px] bg-white text-black receipt-shadow relative receipt-container p-6 pb-12 flex flex-col items-center">
                                    
                                    {/* Header */}
                                    <div className="text-center mb-6 w-full">
                                        <h2 className="text-3xl font-black tracking-tighter mb-1 uppercase">WRITER RECEIPT</h2>
                                        <h3 className="text-sm font-bold tracking-[0.2em] mb-2">2025 EDITION</h3>
                                        <DashedLine />
                                        <div className="text-xs font-bold uppercase flex justify-between w-full mt-2">
                                            <span>DATE: {dateStr}</span>
                                            <span>TIME: {timeStr}</span>
                                        </div>
                                        <div className="text-xs font-bold uppercase flex justify-between w-full">
                                            <span>USER: {formData.userName}</span>
                                            <span>NO. 002025</span>
                                        </div>
                                    </div>

                                    <DashedLine />

                                    {/* Total Words */}
                                    <div className="w-full mb-6">
                                        <div className="flex flex-col items-center">
                                            <span className="uppercase text-[10px] font-bold tracking-widest mb-1">TOTAL WORDS PRINTED</span>
                                            {/* 使用 div border 而不是文本虚线，因为这里需要精确控制粗细 */}
                                            <div className="border-t-4 border-black w-full my-2"></div>
                                            <span className="receipt-big-number">{formData.totalWords}</span>
                                            <div className="border-b-4 border-black w-full my-2"></div>
                                        </div>
                                        <div className="mt-8 space-y-3">
                                            <div className="flex items-center gap-2 mb-3">
                                                <span className="receipt-label">TOP WORKS</span>
                                                <span className="border-b-2 border-black flex-grow"></span>
                                            </div>
                                            {[formData.top1, formData.top2, formData.top3].map((work, i) => (
                                                <div key={i} className="flex justify-between items-end">
                                                    <span className="truncate pr-2 font-bold text-sm max-w-[280px]">{i+1}. {work || 'Untitled'}</span>
                                                    <span className="text-[10px] font-bold whitespace-nowrap">RATING A+</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <DashedLine />

                                    {/* Keywords */}
                                    <div className="w-full mb-8 text-center">
                                        <div className="inline-block receipt-label mb-4 uppercase">Keywords Data</div>
                                        <div className="flex flex-wrap justify-center items-end gap-x-4 gap-y-3 px-2">
                                            {formData.keywords.split(/[,，]/).map((k, i) => (
                                                k.trim() && <span key={i} className={`uppercase leading-none ${getCloudStyle(i)}`}>{k.trim()}</span>
                                            ))}
                                        </div>
                                    </div>

                                    <DashedLine />

                                    {/* Content */}
                                    <div className="w-full space-y-8">
                                        {[
                                            { title: 'BEST OPENING', content: formData.bestOpening },
                                            { title: 'BEST ENDING', content: formData.bestEnding },
                                            { title: 'HIGHLIGHT', content: formData.bestParagraph }
                                        ].map((item, i) => item.content && (
                                            <div key={i} className="relative group">
                                                <span className="receipt-label text-xs absolute -top-3 left-0">{item.title}</span>
                                                <div className="pt-3 mt-1">
                                                    <p className="receipt-text">{item.content}</p>
                                                </div>
                                            </div>
                                        ))}
                                        {formData.freeTalk && (
                                            <div className="mt-4">
                                                <div className="border-2 border-black p-4 relative mt-4">
                                                    <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-white px-2">
                                                        <span className="font-black text-xs tracking-widest">FREE TALK</span>
                                                    </div>
                                                    <p className="text-xs text-center font-bold receipt-text" style={{textAlign: 'center'}}>{formData.freeTalk}</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Footer */}
                                    <div className="mt-12 w-full flex flex-col items-center gap-2">
                                        <div className="h-10 w-full flex justify-center items-end px-6 gap-0.5 overflow-hidden">
                                            {[...Array(60)].map((_, i) => (
                                                <div key={i} className="bg-black h-full" style={{ width: Math.random() > 0.5 ? '4px' : '1px', opacity: Math.random() > 0.9 ? 0 : 1 }}></div>
                                            ))}
                                        </div>
                                        <p className="text-[10px] tracking-[0.5em] font-bold mt-1">THANK YOU FOR CREATING</p>
                                    </div>
                                    
                                    {/* 锯齿装饰 */}
                                    <div className="absolute bottom-0 left-0 w-full h-3 z-20" style={{ background: 'linear-gradient(45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #fff 33.333%, #fff 66.667%, transparent 66.667%)', backgroundSize: '10px 20px', backgroundPosition: '0 100%' }}></div>
                                </div>
                            </div>

                            <div className="w-[400px] mt-4 flex flex-col gap-2">
                                <button onClick={downloadReceipt} disabled={isGenerating} className="w-full bg-zinc-200 text-black py-3 text-sm font-bold uppercase tracking-widest hover:bg-white transition-all flex justify-center items-center gap-2">
                                    {isGenerating ? <RefreshCw className="animate-spin" width="16" /> : <Download width="16" />}
                                    {isGenerating ? '生成高清图片' : '保存小票图片'}
                                </button>
                                <p className="text-center text-zinc-600 text-[10px] uppercase tracking-wider">推荐在电脑端使用以获得最佳效果</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WriterReceiptApp />);
    </script>
</body>
</html>
